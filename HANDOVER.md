# プレイヤーリスト調査システム - Handover Document

> **最終更新**: 2026-02-05
> **担当**: Claude Opus 4.5 + たいむさん
> **バージョン**: v5.1

---

## 1. プロジェクト概要

### 目的
オリコン業務における**プレイヤーリストの調査・正誤チェック**を自動化するシステム。

### 対象業界
| 業界 | プレイヤー数 | ファイル |
|------|-------------|----------|
| クレジットカード | 539件 | 【2026年_クレジットカード】プレイヤーリスト.xlsx |
| 動画配信サービス | 36件 | 【2025年_定額制動画配信サービス】プレイヤーリスト.xlsx |
| 中古車販売店 | 16件 | 【20241217修正】2025_中古車販売店_プレイヤーリスト.xlsx |

### 主な機能
1. **プレイヤー正誤チェック** (v4.0 NEW)
   - 撤退・統合・名称変更の自動検出
   - Perplexity/Gemini APIによる最新情報取得
   - アラートレベル別レポート出力

2. **店舗・教室の都道府県別調査** (v3.0)
   - マルチ戦略スクレイピング
   - 静的HTML → ブラウザ自動化 → AI推論

---

## 2. システム構成

```
プレイヤーリスト作成/
├── app_v5.py              # 統合GUI（Streamlit）★メイン
├── app_v4.py              # 正誤チェックGUI
├── app_v3.py              # 店舗調査GUI（旧）
├── app.py                 # 旧バージョン（非推奨）
│
├── core/                  # コアモジュール
│   ├── __init__.py
│   ├── excel_handler.py   # Excel読み書き
│   └── llm_client.py      # LLMクライアント（Perplexity/Gemini）
│
├── investigators/         # 調査モジュール
│   ├── __init__.py
│   ├── base.py            # データ型定義（AlertLevel等）
│   └── player_validator.py # 正誤チェッカー
│
├── store_scraper_v3.py    # 店舗スクレイピングエンジン
├── store_scraper.py       # 旧バージョン
│
├── docs/                  # ドキュメント・本番データ
│   └── プレイヤーリスト/  # ★本番Excel（gitignore対象）
│
├── 出力/                  # 生成ファイル（gitignore対象）
├── start_v4.bat           # v4起動バッチ
├── start_v3.bat           # v3起動バッチ
├── requirements.txt       # 依存関係
└── .gitignore             # Git除外設定
```

---

## 3. 環境設定

### 3.1 必要なAPIキー

`~/.env.local` に以下を設定：

```env
PERPLEXITY_API_KEY=pplx-xxxxxxxxxxxxxxxx
GOOGLE_API_KEY=AIzaxxxxxxxxxxxxxxxxxxxxxxx
```

**重要**: システム環境変数に古いキーがある場合、`.env.local` が優先されます（`override=True`）

### 3.2 依存パッケージ

```bash
pip install -r requirements.txt
```

主要パッケージ:
- `streamlit` - GUI
- `openpyxl` - Excel操作
- `requests` - HTTP通信
- `python-dotenv` - 環境変数
- `google-genai` - Gemini API（新パッケージ）
- `playwright` - ブラウザ自動化（オプション）

---

## 4. 起動方法

### v5.0（統合版）★推奨
```bash
streamlit run app_v5.py
# または
start_v5.bat をダブルクリック
```

### v4.0（正誤チェック）
```bash
streamlit run app_v4.py
```

### v3.0（店舗調査・旧）
```bash
streamlit run app_v3.py
```

---

## 5. 正誤チェック機能詳細

### 5.1 アラートレベル

| レベル | 意味 | 対応 |
|--------|------|------|
| 🔴 緊急 | 撤退・統合 | 即時リスト更新 |
| 🟡 警告 | 名称変更 | リスト更新推奨 |
| 🟢 情報 | URL変更等 | 参考情報 |
| ✅ 正常 | 変更なし | アクション不要 |
| ⚠️ 要確認 | 判断不能 | 手動確認必要 |

### 5.2 出力形式

- **Excelレポート**: アラート別色分け、詳細情報付き
- **CSV**: 全データのエクスポート

### 5.3 API選択

| API | 特徴 | 推奨用途 |
|-----|------|----------|
| Perplexity (sonar-pro) | Web検索+最新情報 | **正誤チェック**（推奨） |
| Gemini (2.5-flash) | 高速・低コスト | バックアップ |

---

## 6. 今回の変更履歴

### v5.1 (2026-02-05) - 店舗調査精度向上

#### 問題点
- 店舗調査で多くの都道府県が「?」（不明）になる問題
- 原因: プロンプト設計の問題（検索の深さではなく）

#### 改善内容

**1. プロンプト最適化 (`store_investigator.py`)**
- 店舗一覧ページの発見を最優先タスクに変更
- 「null」の使用条件を厳格化（店舗一覧が見つからない場合のみ）
- `store_list_url` フィールドを追加（ソースURL必須化）

**2. AIモデル選択UI追加 (`app_v5.py`)**
| モード | モデル | 特徴 |
|--------|--------|------|
| AI調査（高速） | sonar-pro | デフォルト、低コスト |
| AI調査（精密） | sonar-deep-research | 5分/件、高コスト |

**3. 期待効果**
| 指標 | 改善前 | 改善後 |
|------|--------|--------|
| `?` の割合 | 70%+ | 30%以下 |
| コスト | - | 変化なし |

### v5.0 (2026-02-05) - AI店舗調査統合

- `app_v5.py` - v3+v4の機能を統合
- AI調査をデフォルトに変更
- 都道府県別出力を○/×/?形式に

### v4.0 (2026-02-04)

#### 新規実装
- `core/` モジュール群
- `investigators/` モジュール群
- `app_v4.py` - 正誤チェックGUI

#### セキュリティ改善
- `.gitignore`: 本番Excel除外
- APIキー表示削除（「設定済み」のみ）
- `os.system()` → `subprocess.Popen()`
- `load_dotenv(override=True)` 統一

#### バグ修正
- Geminiモデル名更新（`gemini-2.5-flash`）
- 環境変数優先順位修正

---

## 7. 既知の課題・今後の拡張

### 7.1 未実装機能
- [ ] クレカブランド調査（Phase 3）
- [ ] 動画配信カテゴリ調査（Phase 4）
- [ ] 新規参入プレイヤー自動検出

### 7.2 改善候補
- [ ] バッチ処理の並列化強化
- [ ] キャッシュ機能（重複調査防止）
- [ ] Slack/Teams通知連携

### 7.3 注意事項
- Perplexity APIは従量課金（1件約$0.01-0.05）
- 大量チェック時はコスト注意
- 信頼度60%未満は手動確認推奨

---

## 8. トラブルシューティング

### Q: APIエラー 401 Unauthorized
**A**: `.env.local` のキーが古い可能性。
- `~/.env.local` を確認
- システム環境変数に古いキーがないか確認

### Q: Excelが読み込めない
**A**: ヘッダー行の位置を確認。
- 4行目にヘッダーがある形式に対応
- 「サービス名」「事業者名」列を自動検出

### Q: Gemini APIエラー
**A**: モデル名が古い可能性。
- `gemini-2.5-flash` を使用（2.0は廃止予定）
- `google-genai` パッケージを更新

---

## 9. コンタクト

- **開発**: Claude Opus 4.5 (AI)
- **運用**: たいむさん
- **リポジトリ**: プライベート（GitHub）

---

*このドキュメントは引き継ぎ・メンテナンス用です。*
